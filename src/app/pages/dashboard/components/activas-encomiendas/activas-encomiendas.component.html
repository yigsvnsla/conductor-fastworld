<ion-header>
  <ion-toolbar>
    <app-btn-menu slot="start"></app-btn-menu>
    <ion-title>Encomiendas Activas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [scrollY]="false">
  <cdk-virtual-scroll-viewport itemSize="370" minBufferPx="900" maxBufferPx="1350" class="ion-content-scroll-host">
    <ng-container *ngIf="this.source as Source">
      <ion-card *cdkVirtualFor="let item of Source ; let i = index">
        <ion-item>
          <ion-icon slot="start" name="cube"></ion-icon>
          <ion-label>
            <ion-text color="orange">#{{item.id}}</ion-text> Encomienda
          </ion-label>
          <ion-buttons slot="end">
            <ion-button [id]="i">
              <ion-icon slot="icon-only" name="ellipsis-horizontal"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-popover side="top" alignment="end" reference="trigger" [trigger]="i" [dismissOnSelect]="true">
            <ng-template>
              <ion-content>
                <ion-item-group>
                  <ion-item [detail]="false" [button]="true" *ngIf="item.attributes.receiver == null" (click)="this.sharePackage(item.id)">
                    <ion-icon color="orange" name="link" slot="start"></ion-icon>
                    <ion-label>Generar Confirmación</ion-label>
                  </ion-item>
                  <ion-item [button]="true" [detail]="false" (click)="selectPackage(item,i)">
                    <ion-label>Seleccionar</ion-label>
                    <ion-icon color="orange" slot="start" name="add"></ion-icon>
                  </ion-item>
                  <ion-item *ngIf="item.attributes.receiver != null" [href]="'https://www.google.com/maps/dir/' + item.attributes.location.position.lat + ',' + item.attributes.location.position.lng + '/' + item.attributes.receiver.direction.position.lat + ',' + item.attributes.receiver.direction.position.lng " target="_blank" rel="noreferrer external" [button]="true" [detail]="false">
                    <ion-label>Ver Ruta en Mapas </ion-label>
                    <ion-icon color="orange" slot="start" name="map"></ion-icon>
                  </ion-item>
                </ion-item-group>
              </ion-content>
            </ng-template>
          </ion-popover>
        </ion-item>
        <ion-grid fixed>
          <ion-row>
            <ion-col size="6">
              <ion-item>
                <ion-label>
                  <p>Fecha de Creación</p>
                  <h2>{{item.attributes.createdAt | date:'short'}}</h2>
                </ion-label>
              </ion-item>
            </ion-col>
            <ion-col size="6">
              <ion-item>
                <ion-label>
                  <p>Tiempo de Retiro:</p>
                  <h2>{{'calculando'}}</h2>
                </ion-label>
              </ion-item>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="6">
              <ion-item lines="none">
                <ion-label>
                  <p>
                    <ion-text color="orange">
                      <ion-icon name="flag"></ion-icon> Estado
                    </ion-text>
                  </p>
                  <h2 [ngSwitch]="item.attributes.shipping_status">
                    <ion-text *ngSwitchCase="'aceptado'" color="tertiary">
                      <p>{{ item.attributes.shipping_status | titlecase}}</p>
                    </ion-text>
                    <ion-text *ngSwitchCase="'entregado'" color="success">
                      <p>{{ item.attributes.shipping_status | titlecase}}</p>
                    </ion-text>
                    <ion-text *ngSwitchCase="'invalido'" color="medium">
                      <p>{{ item.attributes.shipping_status | titlecase}}</p>
                    </ion-text>
                    <ion-text *ngSwitchCase="'pendiente'" color="dark">
                      <p>{{ item.attributes.shipping_status | titlecase}}</p>
                    </ion-text>
                    <ion-text *ngSwitchCase="'recibido'" color="primary">
                      <p>{{ item.attributes.shipping_status | titlecase}}</p>
                    </ion-text>
                    <ion-text *ngSwitchCase="'reportado'" color="danger">
                      <p>{{ item.attributes.shipping_status | titlecase}}</p>
                    </ion-text>
                    <ion-text *ngSwitchDefault color="dark">
                      <p>Sin Estado</p>
                    </ion-text>
                  </h2>
                </ion-label>
              </ion-item>
            </ion-col>
            <ion-col size="6">
              <ion-item lines="none">
                <ion-label>
                  <p>Tipo de Encomienda</p>
                  <h2 style="color: var(--ion-color-orange);">{{ (item.attributes.category |titlecase) }}</h2>
                </ion-label>
              </ion-item>
            </ion-col>
          </ion-row>
        </ion-grid>
        <ion-item>
          <ion-icon slot="start" name="person"></ion-icon>
          <ng-container *ngIf="item.attributes.receiver != null; else notReceiver">
            <ion-label>
              <p>Cliente</p>
              <h4>{{(item.attributes.receiver.name | titlecase) }}</h4>
            </ion-label>
            <ion-fab-button href="tel:{{item.attributes.receiver.phone}}" size="small">
              <ion-icon name="call"></ion-icon>
            </ion-fab-button>
            <ion-fab-button [href]="'https://api.whatsapp.com/send?phone=' + item.attributes.receiver.phone.replace('+','')" target="_blank" rel="noopener noreferrer" color="success" size="small">
              <ion-icon name="logo-whatsapp"></ion-icon>
            </ion-fab-button>
          </ng-container>
          <ng-template #notReceiver>
            <ion-label>
              <p>Cliente</p>
              <h4>Esperando confirmnación</h4>
            </ion-label>
          </ng-template>
        </ion-item>
        <ion-item>
          <ion-icon name="bicycle" slot="start"></ion-icon>
          <ng-template *ngIf="item.attributes.driver != null; else notConductor">
            <ion-label>
              <p>Conductor</p>
              <h4>item.driver [sin asignar]</h4>
            </ion-label>
            <ion-fab-button href="tel:{{item.attributes.receiver.phone}}" size="small">
              <ion-icon name="call"></ion-icon>
            </ion-fab-button>
            <ion-fab-button [href]="'https://api.whatsapp.com/send?phone=' + item.attributes.receiver.phone.replace('+','')" target="_blank" rel="noopener noreferrer" color="success" size="small">
              <ion-icon name="logo-whatsapp"></ion-icon>
            </ion-fab-button>
          </ng-template>
          <ng-template #notConductor>
            <ion-label>
              <p>Conductor</p>
              <h4>Sin asignar</h4>
            </ion-label>
          </ng-template>
        </ion-item>
        <ion-card-header class="ion-no-padding">
          <ion-accordion-group>
            <ion-accordion>
              <ion-item class="ion-text-center" slot="header">
                <ion-label>Información</ion-label>
              </ion-item>
              <ion-item-group slot="content">
                <ion-item-divider>
                  <ion-label>Información de Retiro</ion-label>
                </ion-item-divider>
                <ion-item button [href]="'https://maps.google.com/?q=' + item.attributes.location.position.lat + ',' + item.attributes.location.position.lng" target="_blank" rel="noreferrer external">
                  <ion-label class="ion-text-wrap">
                    <p>Dirección de Retiro</p>
                    <h4>{{item.attributes.location.address}}</h4>
                  </ion-label>
                  <ion-icon slot="start" name="map"></ion-icon>
                </ion-item>
                <ion-item-divider>
                  <ion-label>Indicaciones de Entrega</ion-label>
                </ion-item-divider>
                <ion-item *ngIf="item.attributes.receiver != null; else notDirection" button [href]="'https://maps.google.com/?q=' +  item.attributes.receiver.direction.position.lat + ',' +  item.attributes.receiver.direction.position.lng" target="_blank" rel="noreferrer external">
                  <ion-label class="ion-text-wrap">
                    <p>Dirección de Entrega</p>
                    <h4>{{ item.attributes.receiver.direction.address}}</h4>
                  </ion-label>
                  <ion-icon slot="start" name="map"></ion-icon>
                </ion-item>
                <ng-template #notDirection>
                  <ion-item>
                    <ion-label class="ion-text-wrap">
                      <p>Dirección de Entrega</p>
                      <h4>Sin Especificar</h4>
                    </ion-label>
                    <ion-icon slot="start" name="map"></ion-icon>
                  </ion-item>
                </ng-template>
              </ion-item-group>
            </ion-accordion>
          </ion-accordion-group>
        </ion-card-header>
      </ion-card>
      <ion-card *ngIf="(source.loading | async)">
        <ion-card-header class="ion-text-center">
          <ion-card-subtitle>Buscando Información</ion-card-subtitle>
          <ion-spinner name="circular"></ion-spinner>
        </ion-card-header>
      </ion-card>
    </ng-container>
  </cdk-virtual-scroll-viewport>
</ion-content>